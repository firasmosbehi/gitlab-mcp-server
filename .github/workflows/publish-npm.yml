name: Publish npm Package

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          registry-url: "https://registry.npmjs.org"

      - name: Ensure NPM_TOKEN secret is set
        run: |
          if [ -z "${NPM_TOKEN:-}" ]; then
            echo "NPM_TOKEN is not set. Add it as a repository secret to enable publishing." >&2
            exit 1
          fi
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - run: npm ci
      - run: npm run typecheck
      - run: npm test

      - name: Verify tag matches package.json version
        run: |
          node --input-type=module -e "import fs from 'node:fs'; const pkg=JSON.parse(fs.readFileSync('package.json','utf8')); const tag=process.env.GITHUB_REF_NAME||''; const v=tag.startsWith('v')?tag.slice(1):tag; if(pkg.version!==v){console.error(`Tag version ${v} does not match package.json version ${pkg.version}`); process.exit(1);}"

      - run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
