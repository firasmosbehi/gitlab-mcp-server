name: CI

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"
      - run: npm ci
      - run: npm run typecheck
      - run: npm test
      - run: npm run build
      - name: Verify npm package contents (dry-run)
        run: |
          node --input-type=module -e "import { execSync } from 'node:child_process'; const out=execSync('npm pack --dry-run --ignore-scripts --json',{encoding:'utf8'}); const j=JSON.parse(out); const files=(j?.[0]?.files||[]).map((f)=>f.path||f); const forbidden=files.filter((p)=>String(p).startsWith('src/')||String(p).startsWith('test/')||String(p).startsWith('node_modules/')); if(forbidden.length){console.error('Forbidden files in package:', forbidden); process.exit(1);} if(!files.some((p)=>String(p).startsWith('dist/'))){console.error('dist/ missing from package'); process.exit(1);} console.log('package files ok:', files.length);"
